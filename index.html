<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ã‚¢ãƒ«ãƒ‘ã‚«PC ã‹ã‚“ãŸã‚“ãƒˆãƒ©ãƒ–ãƒ«æ•´ç†ãƒ„ãƒ¼ãƒ«</title>
  <style>
    :root{--bg:#f6f7fb;--card:#fff;--text:#111;--muted:#666;--line:#e6e8ef;--btn:#111;--btnText:#fff;}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Noto Sans JP","Hiragino Kaku Gothic ProN","Yu Gothic UI","Yu Gothic",Meiryo,sans-serif;background:var(--bg);color:var(--text);}
    .wrap{max-width:900px;margin:0 auto;padding:18px;}
    .head{display:flex;gap:12px;align-items:center;justify-content:space-between;margin-bottom:12px;}
    .title{font-size:18px;font-weight:800;}
    .sub{font-size:12px;color:var(--muted);line-height:1.4}
    .card{background:var(--card);border:1px solid var(--line);border-radius:14px;box-shadow:0 1px 2px rgba(0,0,0,.04);}
    .chat{height:min(68vh,640px);overflow:auto;padding:14px;}
    .row{display:flex;margin:10px 0;}
    .bot{justify-content:flex-start;}
    .user{justify-content:flex-end;}
    .bubble{max-width:78%;padding:10px 12px;border-radius:14px;line-height:1.55;font-size:14px;white-space:pre-wrap;}
    .bot .bubble{background:#f1f3f9;border:1px solid var(--line);}
    .user .bubble{background:#111;color:#fff;}
    .chips{display:flex;flex-wrap:wrap;gap:8px;margin-top:10px}
    .chip{border:1px solid var(--line);background:#fff;border-radius:999px;padding:8px 10px;font-size:13px;cursor:pointer;}
    .chip:hover{border-color:#cfd5e6}
    .foot{padding:12px;border-top:1px solid var(--line);display:flex;gap:10px;align-items:center;}
    input[type=text]{flex:1;border:1px solid var(--line);border-radius:10px;padding:10px 12px;font-size:14px;outline:none;}
    input[type=text]:focus{border-color:#b7c0dd}
    button{border:0;border-radius:10px;padding:10px 12px;font-weight:700;cursor:pointer;}
    .primary{background:var(--btn);color:var(--btnText);}
    .ghost{background:#fff;border:1px solid var(--line);color:var(--text);}
    .two{display:flex;gap:10px;flex-wrap:wrap}
    .box{border:1px dashed var(--line);border-radius:12px;padding:10px;background:#fff;}
    textarea{width:100%;min-height:110px;border:1px solid var(--line);border-radius:10px;padding:10px;font-size:13px;line-height:1.5;resize:vertical;}
    .small{font-size:12px;color:var(--muted);}
    .hr{height:1px;background:var(--line);margin:10px 0;}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="head">
      <div>
        <div class="title">ã‚¢ãƒ«ãƒ‘ã‚«PC ã‹ã‚“ãŸã‚“ãƒˆãƒ©ãƒ–ãƒ«æ•´ç†ãƒ„ãƒ¼ãƒ«</div>
        <div class="sub">åˆå¿ƒè€…ã®æ–¹ãŒã€Œä½•ã‚’ä¼ãˆã‚Œã°ã„ã„ã‹åˆ†ã‹ã‚‰ãªã„ã€ã‚’è§£æ¶ˆã™ã‚‹ãŸã‚ã®ã€è³ªå•â†’æ•´ç†â†’æ–‡ç« ç”Ÿæˆãƒ„ãƒ¼ãƒ«ï¼ˆè©¦ä½œï¼‰</div>
      </div>
      <button class="ghost" id="resetBtn">ã‚„ã‚Šç›´ã™</button>
    </div>

    <div class="card">
      <div class="chat" id="chat"></div>
      <div class="foot">
        <input id="freeText" type="text" placeholder="ï¼ˆä»»æ„ï¼‰å›°ã£ã¦ã„ã‚‹å†…å®¹ã‚’çŸ­ãå…¥åŠ›ã—ã¦ Enter ã§ã‚‚OK" />
        <button class="primary" id="sendBtn">é€ä¿¡</button>
      </div>
    </div>

    <div style="margin-top:12px" class="small">
      â€» ã“ã‚Œã¯ã€Œè‡ªå‹•è¨ºæ–­ã€ã§ã¯ãªãã€åˆ‡ã‚Šåˆ†ã‘ã®ãŸã‚ã®æ¡ˆå†…ã§ã™ã€‚å±é™ºã‚’æ„Ÿã˜ã‚‹ç—‡çŠ¶ï¼ˆç„¦ã’è‡­ã„ãƒ»ç…™ãƒ»ç•°éŸ³ãªã©ï¼‰ã®å ´åˆã¯ã™ãé›»æºã‚’æŠœã„ã¦ã‚µãƒãƒ¼ãƒˆã¸ã€‚
    </div>
  </div>

<script>
const KB_URL = "/data/support_kb.json"; // ãƒªãƒã‚¸ãƒˆãƒªã« data/support_kb.json ã‚’ç½®ã

let KB = null;
let state = {
  mode: "pick",       // pick | qa | done
  intentKey: null,
  qIndex: 0,
  answers: []
};

const chat = document.getElementById("chat");
const freeText = document.getElementById("freeText");
const sendBtn = document.getElementById("sendBtn");
const resetBtn = document.getElementById("resetBtn");

function el(tag, attrs={}, children=[]) {
  const e = document.createElement(tag);
  Object.entries(attrs).forEach(([k,v]) => {
    if (k === "class") e.className = v;
    else if (k.startsWith("on")) e.addEventListener(k.slice(2).toLowerCase(), v);
    else e.setAttribute(k, v);
  });
  children.forEach(c => e.appendChild(typeof c === "string" ? document.createTextNode(c) : c));
  return e;
}

function addMsg(role, text) {
  const row = el("div", {class:"row " + (role==="bot"?"bot":"user")});
  row.appendChild(el("div", {class:"bubble"}, [text]));
  chat.appendChild(row);
  chat.scrollTop = chat.scrollHeight;
}

function addChips(items, onPick) {
  const wrap = el("div", {class:"chips"});
  items.forEach(label => {
    wrap.appendChild(el("button", {class:"chip", onclick:()=>onPick(label)}, [label]));
  });
  chat.appendChild(wrap);
  chat.scrollTop = chat.scrollHeight;
}

function getIntent(key) {
  return KB.intents.find(i => i.key === key);
}

function keywordClassify(text) {
  const t = (text || "").toLowerCase();
  let best = {key:"other", score:0};
  for (const it of KB.intents) {
    if (!it.keywords) continue;
    let s = 0;
    for (const kw of it.keywords) {
      if (t.includes(kw.toLowerCase())) s++;
    }
    if (s > best.score) best = {key: it.key, score: s};
  }
  return best.score > 0 ? best.key : "other";
}

function askPick() {
  addMsg("bot", "ã¾ãšè¿‘ã„ã‚‚ã®ã‚’é¸ã‚“ã§ã­ï¼ˆæ–‡ç« ã‚’å…¥åŠ›ã—ã¦åˆ¤å®šã‚‚OKï¼‰");
  const labels = KB.intents.map(i => i.label);
  addChips(labels, (label) => {
    const it = KB.intents.find(x => x.label === label);
    startIntent(it.key);
  });
}

function startIntent(key) {
  const it = getIntent(key);
  state.mode = "qa";
  state.intentKey = key;
  state.qIndex = 0;
  state.answers = [];
  addMsg("user", it.label);
  addMsg("bot", `OKï¼ã€Œ${it.label}ã€ã ã­ã€‚ã„ãã¤ã‹ç¢ºèªã—ã¦ã€æœ€å¾Œã«â€œã‚µãƒãƒ¼ãƒˆã«ä¼ãˆã‚‹æ–‡ç« â€ã‚’è‡ªå‹•ã§ä½œã‚‹ã‚ˆã€‚`);
  
  // è¨€ã„å›ã—ä¾‹ï¼ˆã‚¯ãƒªãƒƒã‚¯ã§å…¥åŠ›æ¬„ã«å…¥ã‚Œã‚‹ï¼‰
  if (it.examples && it.examples.length) {
    addMsg("bot", "ã‚ˆãã‚ã‚‹è¨€ã„å›ã—ä¾‹ï¼ˆã‚¯ãƒªãƒƒã‚¯ã§å…¥åŠ›æ¬„ã«å…¥ã‚‹ï¼‰");
    addChips(it.examples.slice(0, 6), (x) => {
      freeText.value = x;
      freeText.focus();
    });
  }
askNextQuestion();
}

function askNextQuestion() {
  const it = getIntent(state.intentKey);
  const q = it.questions[state.qIndex];
  if (!q) return finish();
  addMsg("bot", q.q);
  if (q.choices && q.choices.length) {
    addChips(q.choices, (choice) => {
      addMsg("user", choice);
      state.answers.push({q: q.q, a: choice});
      state.qIndex++;
      askNextQuestion();
    });
  } else {
    // free text answer
    freeText.placeholder = "ã“ã“ã«å›ç­”ã‚’å…¥åŠ›ã—ã¦ Enterï¼ˆä¾‹ï¼šã‚¨ãƒ©ãƒ¼æ–‡ã‚’ã‚³ãƒ”ãƒš ãªã©ï¼‰";
    freeText.focus();
  }
}

function finish() {
  const it = getIntent(state.intentKey);
  state.mode = "done";

  addMsg("bot", "ã‚ã‚ŠãŒã¨ã†ï¼ã“ã“ã‹ã‚‰ç¢ºèªæ‰‹é †ã‚’å‡ºã™ã­ã€‚");

  // æ‰‹é †
  const steps = it.steps.map((s, idx) => `${idx+1}. ${s}`).join("\n");
  addMsg("bot", steps);

  // æ–‡ç« ç”Ÿæˆ
  const summaryLines = [];
  summaryLines.push(`ã€ç›¸è«‡å†…å®¹ã€‘${it.label}`);
  for (const x of state.answers) summaryLines.push(`- ${x.q}ï¼š${x.a}`);
  summaryLines.push("");
  summaryLines.push("ã€è£œè¶³ã€‘ï¼ˆã‚‚ã—æ›¸ã‘ã‚Œã°ï¼‰ã„ã¤ã‹ã‚‰/ä½•ã‚’ã—ãŸã‚‰ç™ºç”Ÿ/ã‚¨ãƒ©ãƒ¼è¡¨ç¤º/è©¦ã—ãŸã“ã¨ ãªã©");

  const mail = summaryLines.join("\n");
  addMsg("bot", "æœ€å¾Œã«ã€ã‚µãƒãƒ¼ãƒˆã«é€ã‚‹æ–‡ç« ï¼ˆã‚³ãƒ”ãƒšç”¨ï¼‰ã‚’ä½œã£ãŸã‚ˆğŸ‘‡");

  const box = el("div", {class:"box"});
  const ta = el("textarea", {id:"outText"}); ta.value = mail;
  const btnRow = el("div", {class:"two"}, [
    el("button", {class:"primary", onclick: async()=> {
      try{ await navigator.clipboard.writeText(ta.value); alert("ã‚³ãƒ”ãƒ¼ã—ãŸã‚ˆï¼"); }catch(e){ alert("ã‚³ãƒ”ãƒ¼ã§ããªã‹ã£ãŸâ€¦æ‰‹å‹•ã§é¸æŠã—ã¦ã‚³ãƒ”ãƒ¼ã—ã¦ã­"); }
    }}, ["ã‚³ãƒ”ãƒ¼"]),
    el("button", {class:"ghost", onclick: ()=> {
      const subject = encodeURIComponent("ã€ã‚¢ãƒ«ãƒ‘ã‚«PCã€‘ã‚µãƒãƒ¼ãƒˆç›¸è«‡");
      const body = encodeURIComponent(ta.value);
      location.href = `mailto:?subject=${subject}&body=${body}`;
    }}, ["ãƒ¡ãƒ¼ãƒ«ã‚’ä½œæˆ"])
  ]);
  box.appendChild(el("div", {class:"small"}, ["â–¼ã‚³ãƒ”ãƒšç”¨ï¼ˆç·¨é›†ã—ã¦OKï¼‰"]));
  box.appendChild(ta);
  box.appendChild(el("div", {class:"hr"}));
  box.appendChild(btnRow);
  chat.appendChild(box);
  chat.scrollTop = chat.scrollHeight;

  freeText.placeholder = "ï¼ˆä»»æ„ï¼‰åˆ¥ã®å†…å®¹ã‚’è©¦ã™ãªã‚‰ã€Œã‚„ã‚Šç›´ã™ã€";
}

function handleFreeTextSend() {
  const text = (freeText.value || "").trim();
  if (!text) return;

  if (state.mode === "pick") {
    // å…¥åŠ›ã‹ã‚‰åˆ¤å®š
    addMsg("user", text);
    const key = keywordClassify(text);
    startIntent(key);
    freeText.value = "";
    return;
  }

  if (state.mode === "qa") {
    const it = getIntent(state.intentKey);
    const q = it.questions[state.qIndex];
    if (q && (!q.choices || q.choices.length === 0)) {
      addMsg("user", text);
      state.answers.push({q: q.q, a: text});
      state.qIndex++;
      freeText.value = "";
      freeText.placeholder = "ï¼ˆä»»æ„ï¼‰å›°ã£ã¦ã„ã‚‹å†…å®¹ã‚’çŸ­ãå…¥åŠ›ã—ã¦ Enter ã§ã‚‚OK";
      askNextQuestion();
      return;
    }
  }

  // done ã®ã¨ãã¯ç„¡è¦–ï¼ˆå¿…è¦ãªã‚‰æ”¹å–„ï¼‰
  freeText.value = "";
}

async function init() {
  addMsg("bot", "èª­ã¿è¾¼ã¿ä¸­â€¦");
  try{
    const res = await fetch(KB_URL, {cache:"no-store"});
    KB = await res.json();
  }catch(e){
    chat.innerHTML = "";
    addMsg("bot", "support_kb.json ãŒèª­ã¿è¾¼ã‚ãªã„ã¿ãŸã„ã€‚ãƒªãƒã‚¸ãƒˆãƒªã« /data/support_kb.json ã‚’ç½®ã„ãŸã‹ç¢ºèªã—ã¦ã­ã€‚");
    return;
  }
  chat.innerHTML = "";
  askPick();
}

sendBtn.addEventListener("click", handleFreeTextSend);
freeText.addEventListener("keydown", (e)=>{ if (e.key==="Enter") handleFreeTextSend(); });
resetBtn.addEventListener("click", ()=>{ chat.innerHTML=""; state={mode:"pick",intentKey:null,qIndex:0,answers:[]}; freeText.value=""; freeText.placeholder="ï¼ˆä»»æ„ï¼‰å›°ã£ã¦ã„ã‚‹å†…å®¹ã‚’çŸ­ãå…¥åŠ›ã—ã¦ Enter ã§ã‚‚OK"; askPick(); });

init();
</script>
</body>
</html>
